<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive Sandbox - Equation Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1115;
            --panel: #181b21;
            --border: #2d313a;
            --primary: #3b82f6; 
            --accent: #f59e0b; 
            --success: #10b981; 
            --danger: #ef4444; 
            --text: #e2e8f0;
            --font-mono: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; background-color: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif; height: 100vh;
            display: grid; grid-template-columns: 380px 1fr; /* Bỏ cột log riêng, tích hợp vào visual cho gọn */
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--panel); border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; overflow-y: auto; gap: 15px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.3); z-index: 10;
        }

        h2 { font-size: 0.9rem; color: var(--primary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border); padding-bottom: 5px;}

        .input-group { background: #000; padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        label { font-size: 0.75rem; color: #94a3b8; font-weight: bold; display: block; margin-bottom: 5px; }
        input { width: 100%; background: #232730; border: 1px solid #4b5563; color: #fff; padding: 8px; border-radius: 4px; font-family: var(--font-mono); }

        .rule-list { display: flex; flex-direction: column; gap: 10px; }
        .rule-card { 
            background: #232730; border: 1px solid var(--border); padding: 10px; 
            border-radius: 6px; border-left: 3px solid var(--accent); position: relative;
        }
        .btn-del { position: absolute; top: 5px; right: 8px; color: var(--danger); cursor: pointer; font-weight: bold; font-size: 1.2rem; }
        .rule-label { font-size: 0.7rem; color: #64748b; margin-top: 5px; display: block; }
        
        button {
            width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; 
            cursor: pointer; transition: 0.2s; font-size: 0.9rem; margin-top: 5px;
        }
        .btn-add { background: #374151; color: #fff; }
        .btn-run { background: var(--success); color: #000; font-size: 1.1rem; margin-top: auto; }
        .btn-run:hover { box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }

        /* --- STAGE --- */
        .stage {
            position: relative; overflow-y: auto; padding: 50px;
            background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; flex-direction: column; align-items: center;
        }

        .node-wrapper {
            display: flex; flex-direction: column; align-items: center;
            animation: slideIn 0.4s ease; margin-bottom: 5px; width: 100%;
        }
        
        .arrow { width: 2px; height: 25px; background: #475569; }
        .arrow.active { background: var(--success); box-shadow: 0 0 10px var(--success); transition: 0.5s; }

        .node {
            background: rgba(15, 23, 42, 0.95); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 8px; min-width: 280px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); backdrop-filter: blur(5px);
            transition: all 0.4s; position: relative;
        }
        
        /* Trạng thái đang tính (Đi xuống) */
        .node.active { border-color: var(--accent); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1); transform: scale(1.02); }
        .node.active .node-title { color: var(--accent); }

        /* Trạng thái đã xong (Đi lên) */
        .node.resolved { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .node.resolved .node-title { color: #94a3b8; font-size: 0.9rem; } /* Làm mờ tiêu đề gốc */

        .node-title { font-family: var(--font-mono); font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; }
        .node-desc { font-size: 0.8rem; color: #64748b; font-style: italic; }

        /* RESULT BOX - THE IMPORTANT PART */
        .result-box {
            margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);
            display: none; animation: expand 0.3s forwards;
        }
        .node.resolved .result-box { display: block; }

        .equation { font-family: var(--font-mono); font-size: 0.9rem; color: #cbd5e1; margin-bottom: 4px; }
        .recursive-call { color: var(--accent); font-weight: bold; } /* f(10) */
        .final-val { font-size: 1.4rem; font-weight: bold; color: var(--success); text-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes expand { from { opacity: 0; transform: scaleY(0); } to { opacity: 1; transform: scaleY(1); } }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2>1. Tham số</h2>
        <div class="input-group">
            <label>Giá trị n:</label>
            <input type="number" id="inpN" value="20">
        </div>

        <h2 style="margin-top:20px">2. Luật (Rules)</h2>
        <div id="ruleList" class="rule-list"></div>
        
        <button class="btn-add" onclick="addRule()">+ Thêm Luật</button>
        <button class="btn-run" onclick="startEngine()">CHẠY MÔ PHỎNG</button>
    </div>

    <div class="stage" id="stage">
        <div style="margin-top:150px; color:#64748b; text-align:center">
            <h3>HỆ THỐNG MÔ PHỎNG ĐỆ QUY</h3>
            <p>Nhập quy tắc và nhấn CHẠY để xem cây tính toán.</p>
        </div>
    </div>

    <script>
        // --- DATA ---
        let rules = [
            { cond: "n % 2 === 0", expr: "f(n/2) + 1", desc: "Chẵn" },
            { cond: "n % 2 !== 0 && n > 3", expr: "f(n+3) - 1", desc: "Lẻ > 3" },
            { cond: "true", expr: "(n+1)/2", desc: "Base Case" }
        ];

        // --- UI ---
        function renderRules() {
            const list = document.getElementById('ruleList');
            list.innerHTML = '';
            rules.forEach((r, idx) => {
                const div = document.createElement('div');
                div.className = 'rule-card';
                if(r.cond === 'true') div.style.borderLeftColor = '#10b981';

                div.innerHTML = `
                    ${r.cond !== 'true' ? `<div class="btn-del" onclick="delRule(${idx})">×</div>` : ''}
                    <label>Điều kiện (JS):</label>
                    <input value="${r.cond}" onchange="updateRule(${idx}, 'cond', this.value)" ${r.cond === 'true'?'disabled':''}>
                    <label class="rule-label">Công thức:</label>
                    <input value="${r.expr}" onchange="updateRule(${idx}, 'expr', this.value)" style="color:${r.cond==='true'?'#10b981':'#f59e0b'}">
                    <label class="rule-label">Ghi chú:</label>
                    <input value="${r.desc}" onchange="updateRule(${idx}, 'desc', this.value)">
                `;
                list.appendChild(div);
            });
        }

        function addRule() {
            const base = rules.pop();
            rules.push({ cond: "n > 0", expr: "f(n-1) * 2", desc: "Luật mới" });
            rules.push(base);
            renderRules();
        }
        function delRule(i) { rules.splice(i,1); renderRules(); }
        function updateRule(i, k, v) { rules[i][k] = v; }

        // --- ENGINE ---
        const wait = ms => new Promise(r => setTimeout(r, ms));

        function parseExpr(expr, n) {
            // Regex tìm f(...)
            // Match: [toàn bộ, bên trong ngoặc, phần đuôi]
            const match = expr.match(/f\(([^)]+)\)(.*)/);
            if (match) {
                let nextN;
                try { nextN = new Function('n', `return ${match[1]}`)(n); } catch(e){ nextN = NaN; }
                return { type: 'REC', nextN: nextN, tail: match[2] || '' };
            } else {
                let res;
                try { res = new Function('n', `return ${expr}`)(n); } catch(e){ res = NaN; }
                return { type: 'BASE', result: res, fullExpr: expr.replace(/n/g, n) };
            }
        }

        async function startEngine() {
            const stage = document.getElementById('stage');
            const nStart = parseFloat(document.getElementById('inpN').value);
            stage.innerHTML = '';

            let stack = [];
            let currN = nStart;
            let depth = 0;
            let running = true;
            const MAX_DEPTH = 30;

            // PHASE 1: EXPANSION
            while(running) {
                if(depth > MAX_DEPTH) { alert("Quá sâu!"); return; }

                // Tạo Node UI
                const nodeId = `node-${depth}`;
                const div = document.createElement('div');
                div.className = 'node-wrapper';
                div.innerHTML = `
                    ${depth > 0 ? `<div class="arrow" id="arrow-${depth}"></div>` : ''}
                    <div class="node active" id="${nodeId}">
                        <div class="node-title">f(${currN})</div>
                        <div class="node-desc" id="desc-${nodeId}">Thinking...</div>
                        <div class="result-box" id="res-${nodeId}"></div>
                    </div>
                `;
                stage.appendChild(div);
                
                const nodeEl = document.getElementById(nodeId);
                nodeEl.scrollIntoView({behavior:'smooth', block:'center'});
                await wait(600);

                // Logic tìm luật
                let match = null;
                let parsed = null;
                for(let r of rules) {
                    let isTrue = false;
                    try { isTrue = new Function('n', `return ${r.cond}`)(currN); } catch(e){}
                    if(isTrue) {
                        match = r;
                        parsed = parseExpr(r.expr, currN);
                        document.getElementById(`desc-${nodeId}`).innerText = `${r.desc} ➜ Áp dụng: ${r.expr}`;
                        break;
                    }
                }

                if(!match) { alert("Không tìm thấy luật!"); return; }

                if(parsed.type === 'REC') {
                    // Lưu thông tin để quay lui
                    stack.push({
                        n: currN,
                        nextN: parsed.nextN,
                        tail: parsed.tail,
                        nodeId: nodeId,
                        arrowId: `arrow-${depth+1}`, // Arrow nối xuống con
                        type: 'REC'
                    });
                    currN = parsed.nextN;
                    depth++;
                } else {
                    // Base case
                    stack.push({
                        n: currN,
                        result: parsed.result,
                        nodeId: nodeId,
                        expr: parsed.fullExpr, // Lưu biểu thức gốc (vd: (1+1)/2)
                        type: 'BASE'
                    });
                    running = false; // Stop expanding
                }
                await wait(200);
            }

            // PHASE 2: BACKTRACKING
            let childResult = null;

            // Duyệt ngược stack
            for (let i = stack.length - 1; i >= 0; i--) {
                const step = stack[i];
                const nodeEl = document.getElementById(step.nodeId);
                const resBox = document.getElementById(`res-${step.nodeId}`);
                
                nodeEl.classList.remove('active');
                nodeEl.classList.add('resolved');
                
                // Highlight mũi tên đi lên (nếu có con)
                if (i < stack.length - 1) {
                    const arrow = document.getElementById(stack[i+1].arrowId); // Arrow của con trỏ về mình
                    if(arrow) arrow.classList.add('active'); // Trong code này arrow thuộc về wrapper của con
                }

                await wait(800);

                if (step.type === 'BASE') {
                    // Hiển thị Base Case
                    // Ví dụ: (1+1)/2 = 1
                    resBox.innerHTML = `
                        <div class="equation" style="color:#10b981">Base: ${step.expr}</div>
                        <div class="final-val">= ${step.result}</div>
                    `;
                    childResult = step.result;
                } else {
                    // Hiển thị Recursive Step
                    // Công thức: f(nextN) + tail
                    // Thay thế: f(10) bằng childResult
                    
                    let newVal;
                    try { newVal = eval(`${childResult}${step.tail}`); } catch(e){ newVal = "ERR"; }

                    resBox.innerHTML = `
                        <div class="equation">
                            = <span class="recursive-call">f(${step.nextN})</span>${step.tail}
                        </div>
                        <div class="equation" style="color:#94a3b8">
                            = <span class="recursive-call">${childResult}</span>${step.tail}
                        </div>
                        <div class="final-val">= ${newVal}</div>
                    `;
                    childResult = newVal;
                }
                nodeEl.scrollIntoView({behavior:'smooth', block:'center'});
            }
        }

        renderRules();
    </script>
</body>
</html>